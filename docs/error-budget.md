# Error Budget 机制

> **制定日期**: 2025-10-26
> **版本**: v1.0
> **核心理念**: 平衡创新速度与系统稳定性

---

## 📋 目录

- [什么是 Error Budget](#什么是-error-budget)
- [Error Budget 计算](#error-budget-计算)
- [消耗策略](#消耗策略)
- [决策矩阵](#决策矩阵)
- [实施流程](#实施流程)

---

## 什么是 Error Budget

### 核心概念

**Error Budget（错误预算）** = 1 - SLO

允许的错误额度，用于平衡创新速度与系统稳定性的工具。

### 为什么需要 Error Budget

#### 传统问题

❌ **过度追求稳定性**:

- 发布缓慢
- 创新受阻
- 团队士气低落

❌ **过度追求速度**:

- 频繁故障
- 用户体验差
- 信任度下降

#### Error Budget 解决方案

✅ **量化权衡**:

- 明确可承受的错误率
- 数据驱动决策
- 平衡速度与稳定性

✅ **共同目标**:

- 开发团队：利用预算加速创新
- SRE 团队：保护预算确保稳定
- 产品团队：在预算范围内规划路线图

---

## Error Budget 计算

### 系统级 Error Budget

#### SLO: 99.9% 可用性

```
Error Budget = 1 - 0.999 = 0.001 = 0.1%
```

#### 月度预算（30 天）

```
总时间 = 30 × 24 × 60 = 43,200 分钟
Error Budget = 43,200 × 0.001 = 43.2 分钟
```

#### 周度预算

```
周度预算 = 43.2 / 4.3 ≈ 10 分钟
```

#### 日度预算

```
日度预算 = 43.2 / 30 ≈ 1.44 分钟
```

### 请求级 Error Budget

#### 假设

- 平均 QPS: 500
- 月度总请求: 500 × 30 × 24 × 3600 = 1,296,000,000（12.96 亿）

#### Error Budget

```
允许失败请求 = 1,296,000,000 × 0.001 = 1,296,000（129.6 万）
日度允许失败 = 1,296,000 / 30 = 43,200
小时允许失败 = 43,200 / 24 = 1,800
```

---

## 消耗策略

### Error Budget 状态

| 剩余预算 | 状态    | 策略                 | 发布频率 | 风险偏好 |
| -------- | ------- | -------------------- | -------- | -------- |
| > 80%    | 🟢 充足 | 加速创新             | 每天     | 高       |
| 50-80%   | 🟡 正常 | 稳健发布             | 2-3 天   | 中       |
| 20-50%   | 🟠 紧张 | 减缓节奏             | 每周     | 低       |
| 5-20%    | 🔴 告急 | 冻结新功能           | 仅修复   | 极低     |
| < 5%     | 🔥 归零 | 紧急模式，专注稳定性 | 禁止     | 零       |

### 详细策略

#### 🟢 充足（> 80%）

**发布策略**:

- ✅ 可以每天发布
- ✅ 可以进行架构重构
- ✅ 可以进行性能实验
- ✅ 可以尝试新技术

**测试要求**:

- 基础测试覆盖即可
- 快速回归测试
- 简化代码审查

**风险承受**:

- 接受一定的失败风险
- 鼓励快速迭代
- 容忍小规模故障

#### 🟡 正常（50-80%）

**发布策略**:

- ✅ 正常发布节奏（2-3 天）
- ⚠️ 重大变更需额外审查
- ⚠️ 限制大规模重构

**测试要求**:

- 标准测试覆盖
- 完整回归测试
- 正常代码审查流程

**风险承受**:

- 审慎评估风险
- 优先修复已知问题
- 关注稳定性趋势

#### 🟠 紧张（20-50%）

**发布策略**:

- ⚠️ 减缓发布频率（每周）
- ⚠️ 仅发布高价值功能
- 🚫 禁止大规模重构

**测试要求**:

- 强化测试覆盖（≥ 80%）
- 多轮回归测试
- 严格代码审查
- 增加金丝雀比例

**风险承受**:

- 极其审慎
- 优先稳定性修复
- 推迟低优先级功能

#### 🔴 告急（5-20%）

**发布策略**:

- 🚫 **冻结新功能发布**
- ✅ 仅允许稳定性修复
- ✅ 仅允许紧急安全补丁

**测试要求**:

- 每个修复必须有测试
- 完整的影响分析
- Tech Lead 必须审批

**响应措施**:

- 启动专项稳定性改进计划
- 每日站会回顾
- 分析 Error Budget 消耗原因
- 制定恢复路线图

#### 🔥 归零（< 5%）

**发布策略**:

- 🚫 **全面冻结**
- ✅ 仅允许回滚和热修复

**响应措施**:

- **进入紧急模式**
- **全员专注稳定性**
- **每日 CTO 级别回顾**
- **所有发布需 CTO 审批**

**恢复计划**:

1. 立即分析根因
2. 实施紧急修复
3. 验证修复效果
4. 恢复 Error Budget 至 > 20%
5. 总结并预防

---

## 决策矩阵

### 场景 1: 新功能发布

| Error Budget 状态 | 功能优先级 | 决策        | 附加条件               |
| ----------------- | ---------- | ----------- | ---------------------- |
| > 80%             | P0         | ✅ 立即发布 | 标准测试               |
| > 80%             | P1/P2      | ✅ 正常发布 | 标准测试               |
| 50-80%            | P0         | ✅ 正常发布 | 增强测试               |
| 50-80%            | P1         | ✅ 正常发布 | 增强测试 + 严格审查    |
| 50-80%            | P2         | ⚠️ 延后     | -                      |
| 20-50%            | P0         | ⚠️ 仔细评估 | 金丝雀 5% → 20% → 100% |
| 20-50%            | P1/P2      | 🚫 推迟     | -                      |
| < 20%             | 任何       | 🚫 冻结     | -                      |

### 场景 2: 架构重构

| Error Budget 状态 | 重构规模 | 决策        | 附加条件                     |
| ----------------- | -------- | ----------- | ---------------------------- |
| > 80%             | 大规模   | ✅ 可以进行 | 分阶段实施 + 完整回滚计划    |
| > 80%             | 中规模   | ✅ 可以进行 | 分阶段实施                   |
| 50-80%            | 大规模   | ⚠️ 延后     | 除非有明确稳定性收益         |
| 50-80%            | 中规模   | ⚠️ 谨慎     | 必须有回滚计划               |
| < 50%             | 任何     | 🚫 禁止     | 专注稳定性，等预算恢复后再做 |

### 场景 3: 性能实验

| Error Budget 状态 | 实验影响 | 决策        | 附加条件              |
| ----------------- | -------- | ----------- | --------------------- |
| > 80%             | 任何     | ✅ 可以进行 | 标准 A/B 测试流程     |
| 50-80%            | 低风险   | ✅ 可以进行 | 小规模用户群（< 5%）  |
| 50-80%            | 中高风险 | ⚠️ 延后     | -                     |
| < 50%             | 任何     | 🚫 禁止     | 等预算恢复至 50% 以上 |

---

## 实施流程

### 1. 监控与追踪

#### 实时监控

**Prometheus 查询**:

```promql
# 月度 Error Budget 剩余百分比
(0.001 - (
  sum(increase(http_requests_total{status=~"5.."}[30d]))
  /
  sum(increase(http_requests_total[30d]))
)) / 0.001 * 100
```

**Grafana 面板**:

- 当前剩余百分比（饼图）
- 消耗趋势（时间线图）
- 预计耗尽时间（数值）
- 按服务分解（条形图）

#### 告警规则

```yaml
# Error Budget 低于 20%
- alert: ErrorBudgetLow
  expr: |
    (0.001 - (
      sum(increase(http_requests_total{status=~"5.."}[30d]))
      /
      sum(increase(http_requests_total[30d]))
    )) / 0.001 < 0.2
  labels:
    severity: warning
  annotations:
    summary: 'Error Budget 低于 20%，建议减缓发布'

# Error Budget 低于 5%
- alert: ErrorBudgetCritical
  expr: |
    (0.001 - (
      sum(increase(http_requests_total{status=~"5.."}[30d]))
      /
      sum(increase(http_requests_total[30d]))
    )) / 0.001 < 0.05
  labels:
    severity: critical
  annotations:
    summary: 'Error Budget 低于 5%，冻结新功能发布'
```

### 2. 发布流程集成

#### 发布前检查

```bash
#!/bin/bash
# scripts/check-error-budget.sh

BUDGET=$(curl -s "http://prometheus:9090/api/v1/query" \
  --data-urlencode 'query=(0.001 - (sum(increase(http_requests_total{status=~"5.."}[30d])) / sum(increase(http_requests_total[30d])))) / 0.001' \
  | jq -r '.data.result[0].value[1]')

if (( $(echo "$BUDGET < 0.05" | bc -l) )); then
  echo "❌ Error Budget < 5%, 发布被阻止"
  exit 1
elif (( $(echo "$BUDGET < 0.2" | bc -l) )); then
  echo "⚠️  Error Budget < 20%, 需要 Tech Lead 审批"
  exit 2
else
  echo "✅ Error Budget 充足: ${BUDGET}%"
  exit 0
fi
```

#### GitHub Action 集成

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  check-error-budget:
    runs-on: ubuntu-latest
    steps:
      - name: Check Error Budget
        id: budget
        run: |
          ./scripts/check-error-budget.sh
        continue-on-error: true

      - name: Require Approval if Low
        if: steps.budget.outcome == 'failure'
        uses: trstringer/manual-approval@v1
        with:
          approvers: tech-lead,cto
          minimum-approvals: 1
          issue-title: 'Error Budget 低，需要审批部署'

  deploy:
    needs: check-error-budget
    runs-on: ubuntu-latest
    steps:
      - name: Deploy
        run: |
          # 部署逻辑
```

### 3. 周度回顾

#### 回顾会议（每周一 10:00）

**议程**:

1. **上周 Error Budget 消耗情况**（10 分钟）

   - 总消耗百分比
   - 主要消耗来源
   - 与上周对比

2. **事故回顾**（15 分钟）

   - 上周故障列表
   - 每个故障消耗的预算
   - 根因与改进措施

3. **本周计划**（15 分钟）

   - 计划发布的功能
   - 预计 Error Budget 消耗
   - 风险评估

4. **行动项**（10 分钟）
   - 稳定性改进措施
   - 责任人与截止日期

#### 会议产物

- Error Budget 周报
- 行动项清单
- 下周发布计划

### 4. 月度重置

#### 重置时间

每月 1 号 00:00 UTC

#### 重置流程

1. **计算上月消耗**

   - 总消耗百分比
   - 故障次数与影响
   - 趋势分析

2. **生成月度报告**

   - 发送给 Tech Lead、CTO
   - 包含改进建议

3. **重置 Error Budget**

   - 恢复至 100%
   - 记录历史数据

4. **调整策略**（如需要）
   - SLO 是否需要调整
   - Error Budget 是否合理
   - 流程是否需要优化

---

## 成功案例

### 案例 1: Google

- **SLO**: 99.99% 可用性
- **Error Budget**: 52.56 分钟/年
- **使用方式**: 用于推动创新和实验
- **效果**: 在保持高可用性的同时加速发布

### 案例 2: Netflix

- **策略**: Chaos Engineering
- **使用方式**: 在 Error Budget 充足时主动注入故障
- **效果**: 提前发现问题，提升系统韧性

---

## 常见问题

### Q1: Error Budget 归零后如何恢复？

**A**: 分阶段恢复

1. **立即止血** (0-24h)

   - 回滚问题变更
   - 启用降级策略
   - 恢复服务可用性

2. **根因分析** (1-3 天)

   - 5 Why 分析
   - 识别系统性问题
   - 制定改进计划

3. **实施改进** (1-2 周)

   - 修复根因
   - 增加测试覆盖
   - 优化监控告警

4. **恢复发布** (Error Budget > 20%)
   - 验证稳定性
   - 逐步恢复发布节奏

### Q2: Error Budget 长期充足怎么办？

**A**: 可能的原因与对策

1. **SLO 过松**

   - 考虑提高 SLO（如 99.9% → 99.95%）
   - 与用户期望对齐

2. **发布过于保守**

   - 加速发布节奏
   - 鼓励实验和创新

3. **系统过度设计**
   - 评估是否可以简化
   - 降低维护成本

### Q3: 如何分配不同服务的 Error Budget？

**A**: 按服务重要性分配

| 服务类型   | SLO    | Error Budget |
| ---------- | ------ | ------------ |
| **核心**   | 99.95% | 21.9 分钟/月 |
| **重要**   | 99.9%  | 43.8 分钟/月 |
| **一般**   | 99.5%  | 3.6 小时/月  |
| **非关键** | 99%    | 7.2 小时/月  |

---

## 参考资料

- [SLO 定义](slo.md)
- [NFR 基线](nfr-baseline.md)
- [Google SRE Book - Error Budget](https://sre.google/sre-book/embracing-risk/)
- [Implementing SLOs](https://sre.google/workbook/implementing-slos/)

---

**制定人**: SRE Team
**审批**: CTO
**生效日期**: 2025-10-27
**下次审查**: 每季度

---

**💡 核心原则**:

> "Error Budget 不是目标，而是平衡速度与稳定性的工具"

- 充足时：加速创新
- 紧张时：关注稳定
- 归零时：全力恢复
- 长期充足：考虑提高标准
