---
name: RAG Optimization PR
about: Pull Request for RAG Engine optimization features
title: '[RAG Iter-X] Feature Name'
labels: ['area/rag', 'type/feat']
---

## 📋 变更描述

**相关迭代**: Iter X - 任务 X.Y

**功能简述**:
<!-- 简要描述本次变更的功能 -->

**影响范围**:
- [ ] 检索模块
- [ ] 重排模块
- [ ] 生成模块
- [ ] 缓存模块
- [ ] 配置文件
- [ ] 其他: ______

---

## 📊 性能影响

### 延迟变化

| 指标 | Before (ms) | After (ms) | 变化 |
|------|-------------|------------|------|
| **E2E 延迟 P95** | | | |
| **检索延迟 P95** | | | |
| **重排延迟 P95** | | | |
| **LLM 延迟 P95** | | | |

### Token 消耗变化

| 阶段 | Before | After | 变化 |
|------|--------|-------|------|
| **检索（Embedding）** | | | |
| **生成（LLM Input）** | | | |
| **生成（LLM Output）** | | | |
| **验证（Self-Check）** | | | |
| **总计** | | | |

### 缓存效果

- **命中率**: ____% (Before) → ____% (After)
- **平均响应时间（命中）**: ____ ms
- **平均响应时间（未命中）**: ____ ms

---

## ✅ 质量验证

### 离线评测

- [ ] 评测集通过
  - 数据集: `____`
  - 样本数: ____
  - 准确率: ____% (目标: >____%)

### A/B 测试数据

<!-- 附上 A/B 测试对比截图或链接 -->

| 指标 | Control (A) | Variant (B) | 提升 | p-value |
|------|------------|-------------|------|---------|
| 准确率 | | | | |
| 幻觉率 | | | | |
| 用户满意度 | | | | |

**A/B 测试报告**: [链接]

### 人工抽检

- [ ] 人工抽检完成
  - 抽检样本数: ____
  - 准确样本数: ____
  - 准确率: ____%

**抽检样本**:
```
1. Query: "______"
   Expected: "______"
   Actual: "______"
   ✅/❌

2. Query: "______"
   ...
```

---

## 💰 成本评估

### Token 成本变化

- **平均成本/请求**: $ ____ (Before) → $ ____ (After)
- **预计每日成本**: $ ____ (假设 10k 请求/天)
- **成本节省**: ____%

### 计算资源变化

| 资源 | Before | After | 变化 |
|------|--------|-------|------|
| **CPU 使用率** | | | |
| **内存使用** | | | |
| **GPU 使用** (如有) | | | |
| **存储** (缓存) | | | |

---

## 🔙 回滚计划

### Feature Flag

- [ ] 已添加 Feature Flag: `ENABLE_____`
  - 默认值: `false` / `true`
  - 环境变量: `RAG_FEATURE_____`

### 监控指标

**关键指标**:
- [ ] `rag______latency_ms`
- [ ] `rag______error_rate`
- [ ] `rag______accuracy`

**告警阈值**:
- [ ] 准确率下降 > 5%
- [ ] 延迟增加 > 20%
- [ ] 错误率 > 1%

### 回滚触发条件

- [ ] 准确率 < ____
- [ ] E2E 延迟 P95 > ____ ms
- [ ] 错误率 > ____%
- [ ] 用户投诉 > ____ 条/小时

### 回滚步骤

```bash
# 1. 关闭 Feature Flag
kubectl set env deployment/rag-engine RAG_FEATURE_____=false -n voiceassistant-prod

# 2. 验证回滚
curl http://rag-engine:8006/health | jq .feature_flags

# 3. 监控指标恢复
# 查看 Grafana Dashboard: [链接]
```

---

## 🔒 安全清单

- [ ] **无新增 PII 数据泄露风险**
  - 说明: ______

- [ ] **输入验证完整**
  - 新增字段: ______
  - 验证规则: ______

- [ ] **限流/降级已配置**
  - QPS 限制: ____
  - 降级策略: ______

- [ ] **敏感数据已脱敏**
  - 日志: ✅ / ❌
  - 追踪: ✅ / ❌
  - 指标: ✅ / ❌

- [ ] **依赖安全扫描通过**
  ```bash
  # 新增依赖
  pip install ______==______

  # 安全扫描
  pip-audit
  ```

---

## 📝 测试清单

### 单元测试

- [ ] 新增测试用例: ____ 个
- [ ] 测试覆盖率: ____% (目标: >70%)
- [ ] 所有测试通过

```bash
cd algo/rag-engine
pytest tests/ -v --cov=app --cov-report=html
```

### 集成测试

- [ ] 检索服务集成测试通过
- [ ] LLM 服务集成测试通过
- [ ] 缓存服务集成测试通过

### 性能测试

- [ ] 压力测试完成 (1000 QPS)
  - P50: ____ ms
  - P95: ____ ms
  - P99: ____ ms
  - 错误率: ____%

```bash
# 压力测试命令
k6 run tests/load/rag_test.js --vus 100 --duration 5m
```

---

## 📖 文档更新

- [ ] **代码注释**
  - 关键函数已注释
  - 复杂逻辑已说明

- [ ] **配置文档**
  - [ ] `configs/rag-engine.yaml` 已更新
  - [ ] 新增配置项说明

- [ ] **API 文档**
  - [ ] 新增/修改 API 端点文档
  - [ ] 请求/响应示例

- [ ] **Runbook 更新** (如需要)
  - [ ] 故障排查步骤
  - [ ] 常见问题 FAQ

---

## 🔗 相关链接

- **Issue**: #____
- **设计文档**: [链接]
- **评测报告**: [链接]
- **Grafana Dashboard**: [链接]
- **A/B 测试结果**: [链接]

---

## 📸 截图 / 演示

<!-- 可选：附上功能演示截图、指标对比图、架构图等 -->

### 指标对比

![Performance Comparison](url)

### 功能演示

![Feature Demo](url)

---

## 👥 Review 清单

**请 Reviewer 关注**:
- [ ] 代码质量与可维护性
- [ ] 性能影响（延迟、Token）
- [ ] 成本影响
- [ ] 测试覆盖度
- [ ] 安全风险
- [ ] 回滚方案可行性
- [ ] 文档完整性

---

## 📋 Merge 前检查

**CI/CD**:
- [ ] ✅ Lint 通过 (golangci-lint / ruff)
- [ ] ✅ 单元测试通过
- [ ] ✅ 集成测试通过
- [ ] ✅ 性能测试通过
- [ ] ✅ 安全扫描通过

**人工验证**:
- [ ] ✅ 代码 Review 通过 (至少 2 人)
- [ ] ✅ QA 验收通过
- [ ] ✅ Tech Lead 审批

**部署准备**:
- [ ] ✅ Feature Flag 已配置
- [ ] ✅ 监控告警已配置
- [ ] ✅ Runbook 已更新
- [ ] ✅ 回滚计划已确认

---

## 🚀 部署计划

### Staging 环境

- **部署时间**: ____
- **验证步骤**:
  1. ______
  2. ______
- **验证通过时间**: ____

### Production 环境

- **部署策略**: Canary / Blue-Green / Rolling
- **Canary 比例**: ____% → ____% → 100%
- **部署时间窗口**: ____
- **负责人**: ____

---

**提交人**: @______
**提交时间**: ____
**预计合并时间**: ____
